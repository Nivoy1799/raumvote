generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model VotingSession {
  id               String    @id @default(cuid())
  treeId           String    @unique
  title            String?
  status           String    @default("draft") // draft | active | archived
  durationDays     Int       @default(30)
  startedAt        DateTime?
  endedAt          DateTime?

  // Tree config (merged from TreeConfig)
  rootNodeId       String?
  systemPrompt     String    @db.Text @default("")
  modelName        String    @default("gpt-4o")
  placeholderUrl   String    @default("/media/placeholder.jpg")
  discoveryEnabled Boolean   @default(true)
  imageModel       String    @default("gemini-2.0-flash-preview-image-generation")
  imagePrompt      String?   @db.Text
  referenceMedia   String[]  @default([])

  // Relations
  nodes            TreeNode[]
  votes            Vote[]
  likes            Like[]
  comments         Comment[]
  imageTasks       ImageTask[]

  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
}

model Vote {
  id          String         @id @default(cuid())
  sessionId   String
  session     VotingSession  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  optionId    String
  voterHash   String
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@unique([sessionId, voterHash])
}

model Like {
  id          String         @id @default(cuid())
  sessionId   String
  session     VotingSession  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  optionId    String
  voterHash   String
  createdAt   DateTime       @default(now())

  @@unique([sessionId, optionId, voterHash])
}

model User {
  id        String   @id @default(cuid())
  voterHash String   @unique
  username  String?
  avatarUrl String?  @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Comment {
  id          String         @id @default(cuid())
  sessionId   String
  session     VotingSession  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  optionId    String
  voterHash   String
  text        String         @db.Text
  parentId    String?
  parent      Comment?       @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies     Comment[]      @relation("CommentReplies")
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  likes       CommentLike[]

  @@index([sessionId, optionId, createdAt])
  @@index([parentId])
}

model CommentLike {
  id        String   @id @default(cuid())
  commentId String
  voterHash String
  createdAt DateTime @default(now())
  comment   Comment  @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@unique([commentId, voterHash])
}

model AccessToken {
  id        String   @id @default(cuid())
  token     String   @unique
  label     String?
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
}

model TreeNode {
  id             String         @id @default(cuid())
  sessionId      String
  session        VotingSession  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  titel          String
  beschreibung   String
  context        String         @db.Text
  question       String?
  mediaUrl       String?
  side           String?        // "left" | "right" | null (root)
  depth          Int            @default(0)

  discovererHash String?
  discoveredAt   DateTime?
  amountVisits   Int            @default(0)
  generated      Boolean        @default(false)

  parentId       String?
  parent         TreeNode?      @relation("TreeChildren", fields: [parentId], references: [id], onDelete: Cascade)
  children       TreeNode[]     @relation("TreeChildren")

  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  @@unique([parentId, side])
  @@index([sessionId])
  @@index([parentId])
}

model ImageTask {
  id          String         @id @default(cuid())
  sessionId   String
  session     VotingSession  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  nodeId      String
  nodeTitel   String
  status      String         @default("pending") // pending | generating | completed | failed
  error       String?
  imageUrl    String?
  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime       @default(now())

  @@index([sessionId, status])
  @@index([nodeId])
}
